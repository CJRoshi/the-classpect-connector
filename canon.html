<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Canon Characters - The Classpect Connector</title>
  <link rel="icon" type="image/png" href="./images/special/CCLogoRegular.png" />

  <!-- React 18 -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="./components/mobile.css">

  <!-- Shared Components -->
  <script type="text/babel" src="./components/constants.js"></script>
  <script type="text/babel" src="./components/header.js"></script>
  <script type="text/babel" src="./components/searchbar.js"></script>
  <script type="text/babel" src="./components/footer.js"></script>
  
  <style>
    @font-face {
      font-family: 'Typostuck';
      src: url('./fonts/TYPOSTUCK.ttf') format('truetype');
    }
    
    /* Font families */
    .font-courier { font-family: 'Courier New', monospace; }
    .font-courier-bold { font-family: 'Courier New', monospace; font-weight: bold; }
    .font-typostuck {
      font-family: 'Typostuck', 'Courier New', monospace;
      font-size: 1.25rem;
      font-weight: normal;
    }
    .font-typostuck-title {
      font-family: 'Typostuck', 'Courier New', monospace;
      font-size: 2.5rem;
      font-weight: normal;
    }
    .font-typostuck-header {
      font-family: 'Typostuck', 'Courier New', monospace;
      font-size: 1.75rem;
      font-weight: normal;
    }
    
    /* Homestuck command style */
    .homestuck-command {
      font-family: Verdana, Arial, sans-serif;
      font-weight: bold;
      font-size: 1.25rem;
      color: #000000;
    }
    
    .homestuck-command-dark {
      font-family: Verdana, Arial, sans-serif;
      font-weight: bold;
      font-size: 1.25rem;
      color: #ffffff;
    }
  </style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

/* =========================
   DEFAULT THEME
   ========================= */
const defaultTheme = { 
  bg: "#626262", 
  contentBg: "#d0d0d0", 
  textColor: "#000000", 
  accentBg: "#a0a0a0",
  isDark: false,
  aspectLinkColor: "graph"
};

/* =========================
   DATA LOADING
   ========================= */
let characterData = { canon: {}, nonCanon: {} };

const loadData = async () => {
  try {
    const charactersRes = await fetch('./data/characters.json');
    characterData = await charactersRes.json();
    return true;
  } catch (error) {
    console.error('Error loading data:', error);
    return false;
  }
};

/* =========================
   CHARACTER GROUPING
   ========================= */
const getLastName = (fullName) => {
  const parts = fullName.split(' ');
  return parts[parts.length - 1];
};

const groupCharacters = (characters) => {
  const groups = {
    'SBURB Beta': [],
    'SBURB Alpha': [],
    'SGRUB Beta': [],
    'SGRUB Alpha': [],
    'Cherubs': [],
    'Hiveswap': [],
    'Hauntswitch': [],
    'Pesterquest': [],
    'Beyond Canon': []
  };
  
  // Troll blood caste order
  const trollOrderBeta = [
    'Aradia Megido', 'Tavros Nitram', 'Sollux Captor', 'Karkat Vantas',
    'Nepeta Leijon', 'Kanaya Maryam', 'Terezi Pyrope', 'Vriska Serket',
    'Equius Zahhak', 'Gamzee Makara', 'Eridan Ampora', 'Feferi Peixes'
  ];
  
  const trollOrderAlpha = [
    'Damara Megido', 'Rufioh Nitram', 'Mituna Captor', 'Kankri Vantas',
    'Meulin Leijon', 'Porrim Maryam', 'Latula Pyrope', 'Aranea Serket',
    'Horuss Zahhak', 'Kurloz Makara', 'Cronus Ampora', 'Meenah Peixes'
  ];
  
  // Tag to group mapping
  const TAG_TO_GROUP = {
    'sburb-beta':   'SBURB Beta',
    'sburb-alpha':  'SBURB Alpha',
    'sgrub-beta':   'SGRUB Beta',
    'sgrub-alpha':  'SGRUB Alpha',
    'cherubs':      'Cherubs',
    'hiveswap':     'Hiveswap',
    'hauntswitch':  'Hauntswitch',
    'pesterquest':  'Pesterquest',
    'beyond-canon': 'Beyond Canon',
  };

  // Group priority â€” lower = higher priority group
  // Characters who should be forced into a specific group regardless of tags
  const GROUP_OVERRIDES = {
    'MSPA Reader': 'Beyond Canon',
  };

  const GROUP_PRIORITY = {
    'SBURB Beta':   1,
    'SBURB Alpha':  2,
    'SGRUB Beta':   3,
    'SGRUB Alpha':  4,
    'Cherubs':      5,
    'Beyond Canon': 6,
    'Hiveswap':     7,
    'Hauntswitch':  8,
    'Pesterquest':  9,
  };

  characters.forEach(char => {
    const tags = char.tags || [];

    // Hard override for specific characters
    if (GROUP_OVERRIDES[char.name]) {
      groups[GROUP_OVERRIDES[char.name]].push(char);
      return;
    }

    // Find the highest-priority group this character belongs to
    let bestGroup = null;
    let bestPriority = Infinity;

    tags.forEach(tag => {
      const group = TAG_TO_GROUP[tag];
      if (group && GROUP_PRIORITY[group] < bestPriority) {
        bestGroup = group;
        bestPriority = GROUP_PRIORITY[group];
      }
    });

    if (bestGroup) {
      groups[bestGroup].push(char);
    }
  });
  
  // Sort humans by last name
  ['SBURB Beta', 'SBURB Alpha'].forEach(group => {
    groups[group].sort((a, b) => getLastName(a.name).localeCompare(getLastName(b.name)));
  });
  
  // Sort trolls by blood caste
  groups['SGRUB Beta'].sort((a, b) => {
    return trollOrderBeta.indexOf(a.name) - trollOrderBeta.indexOf(b.name);
  });
  
  groups['SGRUB Alpha'].sort((a, b) => {
    return trollOrderAlpha.indexOf(a.name) - trollOrderAlpha.indexOf(b.name);
  });
  
  // Sort other groups alphabetically
  ['Cherubs', 'Hiveswap', 'Hauntswitch', 'Pesterquest', 'Beyond Canon'].forEach(group => {
    groups[group].sort((a, b) => a.name.localeCompare(b.name));
  });
  
  return groups;
};

const GROUP_ROUTES = {
  'SBURB Beta':    './tag/sburb-beta.html',
  'SBURB Alpha':   './tag/sburb-alpha.html',
  'SGRUB Beta':    './tag/sgrub-beta.html',
  'SGRUB Alpha':   './tag/sgrub-alpha.html',
  'Cherubs':       './tag/cherubs.html',
  'Hiveswap':      './tag/hiveswap.html',
  'Hauntswitch':   './tag/hauntswitch.html',
  'Beyond Canon':  './tag/beyond-canon.html',
  'Pesterquest':   null,
};

/* =========================
   CHARACTER ENTRY COMPONENT
   ========================= */
const CharacterEntry = ({ name, classpect, color, theme }) => {
  const [className, aspectName] = classpect;
  const path = `./index.html#/classpect/${className.toLowerCase()}-of-${aspectName.toLowerCase()}`;
  
  return (
    <div className="font-courier" style={{display: 'flex', gap: '0.5rem'}}>
      <span style={{color: color || (theme?.isDark ? "#ffffff" : "#000000"), fontWeight: 'bold', minWidth: '150px'}}>
        {name}:
      </span>
      <a
        href={path}
        className="font-courier-bold hover:underline"
        style={{color: theme?.isDark ? "#6dd1f4" : "#0000ee", textDecoration: 'none'}}
      >
        {className} of {aspectName}
      </a>
    </div>
  );
};

/* =========================
   CANON PAGE
   ========================= */
const CanonPage = ({ theme }) => {
  const [dataLoaded, setDataLoaded] = useState(false);
  
  useEffect(() => {
    loadData().then(success => {
      if (success) setDataLoaded(true);
    });
  }, []);
  
  if (!dataLoaded) {
    return (
      <div className="text-center">
        <p className="text-2xl font-bold">Loading...</p>
      </div>
    );
  }
  
  // Get all canon characters
  const canonCharacters = Object.entries(characterData.canon)
    .map(([name, data]) => ({
      name,
      classpect: data.classpect,
      color: data.color,
      tags: data.tags || []
    }));
  
  const groups = groupCharacters(canonCharacters);
  
  return (
    <div className="space-y-6">
      {/* Title */}
      <div className="text-center">
        <h1 className="font-typostuck-title mb-2" style={{fontSize: "clamp(1.75rem, 7vw, 3rem)"}}>Canon Characters</h1>
        <p className="font-courier" style={{color: theme?.isDark ? "#cccccc" : "#4b5563"}}>
          All canon characters and their classpects (if confirmed).
        </p>
      </div>
      
      {/* Groups */}
      {Object.entries(groups).map(([groupName, characters]) => {
        if (characters.length === 0) return null;
        
        return (
          <div key={groupName}>
            <h2 className={theme?.isDark ? "homestuck-command-dark mb-3" : "homestuck-command mb-3"}>
              {GROUP_ROUTES[groupName] ? (
                <a href={GROUP_ROUTES[groupName]} style={{ textDecoration: 'none', color: 'inherit' }}
                  onMouseEnter={e => e.currentTarget.style.textDecoration = 'underline'}
                  onMouseLeave={e => e.currentTarget.style.textDecoration = 'none'}
                >
                  {groupName}
                </a>
              ) : groupName}
            </h2>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2">
              {characters.map(({ name, classpect, color }) => (
                <CharacterEntry 
                  key={name}
                  name={name}
                  classpect={classpect}
                  color={color}
                  theme={theme}
                />
              ))}
            </div>
          </div>
        );
      })}
    </div>
  );
};

/* =========================
   APP
   ========================= */
const App = () => {
  const handleNavigate = (path) => {
    window.location.href = `./index.html#${path}`;
  };
  
  return (
    <div style={{ 
      backgroundColor: defaultTheme.bg, 
      minHeight: '100vh'
    }}>
      <Header onNavigate={handleNavigate} theme={defaultTheme} />
      
      <div className="px-3 sm:px-6 pb-6">
        <div className="max-w-4xl mx-auto">
          <SearchBar onNavigate={handleNavigate} theme={defaultTheme} />
          
          <div className="content-box-mobile" style={{
            backgroundColor: defaultTheme.contentBg,
            color: defaultTheme.textColor,
            padding: '24px',
            borderRadius: '8px',
            boxShadow: '0 4px 6px rgba(0,0,0,0.3)',
            border: `2px solid ${defaultTheme.accentBg}`
          }}>
            <CanonPage theme={defaultTheme} />
          </div>
          
          <Footer theme={defaultTheme} />
        </div>
      </div>
    </div>
  );
};

/* =========================
   MOUNT
   ========================= */
const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App />);

</script>
</body>
</html>